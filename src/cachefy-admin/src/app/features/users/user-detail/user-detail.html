<div id="page-user-detail" class="page">
  <div class="grid">
    <section>
      <!-- Loading State -->
      @if (isLoading()) {
      <div class="card">
        <div style="text-align: center; padding: 48px; color: var(--muted)">
          <div
            style="
              display: inline-block;
              width: 40px;
              height: 40px;
              border: 3px solid var(--glass-border);
              border-top-color: var(--accent);
              border-radius: 50%;
              animation: spin 0.8s linear infinite;
            "
          ></div>
          <div style="margin-top: 16px; font-size: 14px">Loading user details...</div>
        </div>
      </div>
      } @else {

      <!-- User Information Card -->
      <div class="card">
        <div class="row" style="align-items: center; justify-content: space-between">
          <h2 class="text-app">
            {{ isNew() ? 'Create New User' : 'User Information' }}
          </h2>
          <button class="btn secondary btn-ripple" (click)="goBack()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Back to Users
          </button>
        </div>

        <div class="row">
          <div class="form-group" style="flex: 1">
            <label for="email">Email Address *</label>
            <input
              id="email"
              type="email"
              [ngModel]="formData().email"
              (ngModelChange)="updateFormField('email', $event)"
              name="email"
              placeholder="user@example.com"
              required
            />
          </div>
        </div>

        <div class="row">
          <div class="form-group" style="flex: 1">
            <label for="role">Role *</label>
            <select
              id="role"
              [ngModel]="formData().role"
              (ngModelChange)="updateFormField('role', $event)"
              name="role"
            >
              @for (role of userRoles; track role.value) {
              <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>
        </div>

        @if (isNew()) {
        <div style="height: 1px; background: var(--border); margin: 24px 0"></div>

        <div class="row">
          <div class="form-group" style="flex: 1">
            <label for="password">Password *</label>
            <input
              id="password"
              type="password"
              [ngModel]="formData().password"
              (ngModelChange)="updateFormField('password', $event)"
              name="password"
              placeholder="Enter password (min 6 characters)"
              required
            />
            <small style="font-size: 12px; color: var(--muted); display: block; margin-top: 4px">
              Minimum 6 characters
            </small>
          </div>
        </div>

        <div class="row">
          <div class="form-group" style="flex: 1">
            <label for="confirmPassword">Confirm Password *</label>
            <input
              id="confirmPassword"
              type="password"
              [ngModel]="formData().confirmPassword"
              (ngModelChange)="updateFormField('confirmPassword', $event)"
              name="confirmPassword"
              placeholder="Confirm password"
              required
            />
            @if (formData().password && formData().confirmPassword && formData().password !==
            formData().confirmPassword) {
            <small style="font-size: 12px; color: #ef4444; display: block; margin-top: 4px">
              Passwords do not match
            </small>
            }
          </div>
        </div>
        }

        <div class="row">
          <div class="form-group button-group" style="flex: 1">
            <div class="button-container" style="display: flex; gap: 12px">
              <button
                class="btn primary btn-ripple"
                (click)="saveUser()"
                [disabled]="!canSave() || isSaving()"
              >
                @if (isSaving()) {
                <div
                  style="
                    display: inline-block;
                    width: 14px;
                    height: 14px;
                    border: 2px solid currentColor;
                    border-top-color: transparent;
                    border-radius: 50%;
                    animation: spin 0.6s linear infinite;
                  "
                ></div>
                {{ isNew() ? 'Creating...' : 'Saving...' }}
                } @else if (isNew()) {
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                  />
                </svg>
                Create User } @else {
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                  />
                </svg>
                Save Changes }
              </button>
              @if (isNew()) {
              <button class="btn ghost" (click)="clearForm()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  />
                </svg>
                Clear
              </button>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Linked Services Overview -->
      @if (!isNew() && user()) {
      <div class="card" style="margin-top: 16px">
        <div
          class="row"
          style="align-items: center; justify-content: space-between; margin-bottom: 20px"
        >
          <div>
            <div class="text-app" style="font-weight: 700">ðŸ”— Linked Services</div>
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px">
              {{ linkedServiceNames().length }} service{{
                linkedServiceNames().length !== 1 ? 's' : ''
              }}
            </div>
          </div>
          <button class="btn primary btn-ripple" (click)="openServiceModal()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            Manage Access
          </button>
        </div>

        @if (linkedServiceNames().length === 0) {
        <div style="text-align: center; padding: 60px 20px; color: var(--muted)">
          <div
            style="
              display: inline-flex;
              width: 80px;
              height: 80px;
              margin-bottom: 16px;
              opacity: 0.3;
              align-items: center;
              justify-content: center;
            "
          >
            <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
              />
            </svg>
          </div>
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px">
            No Services Linked
          </div>
          <div style="font-size: 14px; margin-bottom: 4px">
            This user doesn't have access to any services yet.
          </div>
          <div style="font-size: 13px; color: var(--accent)">
            Use the "Manage Access" button to grant access.
          </div>
        </div>
        } @else {
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
          "
        >
          @for (serviceName of linkedServiceNames(); track serviceName) {
          <div class="card" style="padding: 16px; transition: all 0.3s">
            <div style="display: flex; align-items: center; gap: 12px">
              <div
                style="
                  width: 48px;
                  height: 48px;
                  background: linear-gradient(
                    135deg,
                    rgba(244, 196, 0, 0.15),
                    rgba(255, 204, 51, 0.15)
                  );
                  border-radius: 12px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: var(--accent);
                "
              >
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
                  />
                </svg>
              </div>
              <div style="flex: 1">
                <div style="font-weight: 600; font-size: 15px">{{ serviceName }}</div>
                <div style="font-size: 12px; color: var(--muted); margin-top: 2px">Active</div>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>

      } }
    </section>

    <aside>
      <div class="card">
        <h2 class="text-app"><span style="font-size: 20px">ðŸ’¡</span> Page Guide</h2>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 14px; font-weight: 600; color: var(--accent); margin: 0 0 8px 0">
            User Information
          </h3>
          <p style="font-size: 13px; color: var(--muted); line-height: 1.6; margin: 0">
            Manage user account details including name, email, username, role, and active status.
            All required fields must be filled before saving.
          </p>
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 14px; font-weight: 600; color: var(--accent); margin: 0 0 8px 0">
            User Roles
          </h3>
          <ul
            style="
              font-size: 13px;
              color: var(--muted);
              line-height: 1.8;
              margin: 0;
              padding-left: 20px;
            "
          >
            <li><strong>Admin</strong> - Full system access and user management</li>
            <li><strong>Manager</strong> - Can manage services and view analytics</li>
            <li><strong>User</strong> - Limited access to assigned services only</li>
          </ul>
        </div>

        <div style="margin-bottom: 24px">
          <h3 style="font-size: 14px; font-weight: 600; color: var(--accent); margin: 0 0 8px 0">
            Service Access Control
          </h3>
          <p style="font-size: 13px; color: var(--muted); line-height: 1.6; margin: 0 0 12px 0">
            Control which services this user can access. Use the
            <strong>Manage Access</strong> button to:
          </p>
          <ul
            style="
              font-size: 13px;
              color: var(--muted);
              line-height: 1.8;
              margin: 0;
              padding-left: 20px;
            "
          >
            <li><strong>Link Services</strong> - Grant access to specific services</li>
            <li><strong>Remove Access</strong> - Revoke service permissions</li>
            <li><strong>View Active Links</strong> - See all linked services</li>
          </ul>
        </div>

        <div
          style="
            margin-bottom: 24px;
            padding: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
          "
        >
          <h3
            style="
              font-size: 13px;
              font-weight: 600;
              color: var(--accent);
              margin: 0 0 8px 0;
              display: flex;
              align-items: center;
              gap: 6px;
            "
          >
            <span>ðŸ’¡</span> Quick Tips
          </h3>
          <ul
            style="
              font-size: 12px;
              color: var(--muted);
              line-height: 1.8;
              margin: 0;
              padding-left: 20px;
            "
          >
            <li>Passwords must be at least 6 characters long</li>
            <li>Email addresses must be unique across all users</li>
            <li>Inactive users cannot log in to the system</li>
            <li>Service access changes take effect immediately</li>
          </ul>
        </div>

        <div style="padding-top: 16px; border-top: 1px solid var(--glass-border)">
          <h3 style="font-size: 13px; font-weight: 600; color: var(--muted); margin: 0 0 8px 0">
            Need Help?
          </h3>
          <p style="font-size: 12px; color: var(--muted); line-height: 1.6; margin: 0">
            If you encounter any issues or need assistance managing users, please contact your
            system administrator.
          </p>
        </div>
      </div>
    </aside>
  </div>

  <!-- Service Access Management Modal -->
  <app-modal
    [isOpen]="isServiceModalOpen()"
    [title]="'Manage Service Access'"
    (closeModal)="closeServiceModal()"
  >
    <div class="service-modal-content">
      <!-- Add Service Section -->
      <div class="add-service-section">
        <h3 class="section-title">Link New Service</h3>
        @if (isLoadingServiceNames()) {
        <div class="services-loading">
          <div class="spinner-small"></div>
          <span>Loading services...</span>
        </div>
        } @else {
        <div class="add-service-row">
          <select
            id="serviceSelect"
            [value]="selectedServiceName()"
            (change)="onServiceSelect($event)"
            name="serviceSelect"
            class="service-select"
          >
            <option value="">Select a service...</option>
            @for (serviceName of availableServiceNames(); track serviceName) {
            <option [value]="serviceName">{{ serviceName }}</option>
            }
          </select>
          <button
            class="btn primary btn-ripple"
            (click)="linkService()"
            [disabled]="!selectedServiceName()"
          >
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
              />
            </svg>
            Link Service
          </button>
        </div>
        @if (availableServiceNames().length === 0 && allServiceNames().length > 0) {
        <p class="info-text">All services are already linked to this user.</p>
        } }
      </div>

      <!-- Divider -->
      <div class="modal-divider"></div>

      <!-- Linked Services List -->
      <div class="services-list-section">
        <h3 class="section-title">Currently Linked Services</h3>

        @if (linkedServiceNames().length === 0) {
        <div class="empty-services-modal">
          <div class="empty-icon-small">ðŸ”—</div>
          <p>No services linked yet</p>
          <small>Select a service above to grant access</small>
        </div>
        } @else {
        <div class="services-list-modal">
          @for (serviceName of linkedServiceNames(); track serviceName) {
          <div class="service-item-modal">
            <div class="service-info">
              <div class="service-icon-small">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
                  />
                </svg>
              </div>
              <div class="service-details">
                <div class="service-name">{{ serviceName }}</div>
                <div class="service-meta">Linked service</div>
              </div>
            </div>
            <button
              class="btn-unlink-modal"
              (click)="unlinkService(serviceName)"
              title="Unlink service"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              Remove
            </button>
          </div>
          }
        </div>
        }
      </div>
    </div>
  </app-modal>
</div>
